name: Run PHPUnit Tests

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  phpunit:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'

      - run: composer install
      - run: cp .env.example .env
      - run: php artisan key:generate
      - run: php artisan migrate --env=testing

      - name: Run PHPUnit tests
        id: phpunit_tests
        run: vendor/bin/phpunit

      - name: Send email on failure
        if: failure()  # This line is valid *inside* a step
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚ùå PHPUnit Tests Failed en Laravel App"
          to: exa@gmail.com
          from: Laravel CI/CD <${{ secrets.EMAIL_USERNAME }}>
          body: |
            Los tests de PHPUnit han fallado.
            Revisa los resultados del pipeline en GitHub Actions.
